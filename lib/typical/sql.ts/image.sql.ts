import * as SQLa from "../../mod.ts";
import { schemas } from "../mod.ts";

export const affinityGroup = new schemas.TypicalAffinityGroup("image");

export function SQL(
  ctx: SQLa.DcpInterpolationContext,
  options?: SQLa.InterpolationContextStateOptions,
): SQLa.DcpInterpolationResult {
  const state = ctx.prepareState(
    ctx.prepareTsModuleExecution(import.meta.url),
    options ||
      {
        schema: schemas.lib,
        affinityGroup,
        extensions: [schemas.pgCatalog.plPythonExtn],
      },
  );
  const [sQR] = state.observableQR(state.schema);
  const { lcFunctions: fn } = state.affinityGroup;

  // deno-fmt-ignore
  return SQLa.SQL(ctx, state)`
    -- TODO: perform pip install or upgrade of required packages via an anonymous code block
    -- DO $$
    -- import pip3
    -- pip3.main(["install", "--user", "pillow"])
    -- $$ LANGUAGE plpython3u;

    CREATE OR REPLACE PROCEDURE safe_create_image_meta_data_type() AS $$
    BEGIN
        CREATE TYPE ${sQR("image_meta_data")} AS (
            provenance TEXT,
            image_format TEXT,
            image_width INTEGER,
            image_height INTEGER,
            image_size_bytes INTEGER,
            image_is_valid BOOLEAN,
            image_status_msg TEXT
        );
        CREATE TYPE ${sQR("image_content")} AS (
            provenance TEXT,
            image bytea,
            image_format TEXT,
            image_width INTEGER,
            image_height INTEGER,
            image_size_bytes INTEGER,
            mime_type TEXT,
            image_format_original TEXT,
            image_size_original INTEGER,
            image_width_original INTEGER,
            image_height_original INTEGER,
            image_file_extension_original TEXT,
            mime_type_original TEXT,
            image_hash TEXT, -- TODO: create proper domain
            is_transformed BOOLEAN,
            image_is_valid BOOLEAN,
            image_file_extension TEXT,
            image_status_msg TEXT
        );
    EXCEPTION
        WHEN DUPLICATE_OBJECT THEN
            RAISE NOTICE 'type "image_meta_data" already exists, skipping';
    END;
    $$ LANGUAGE PLPGSQL;

    -- TODO: separate constructIdempotent into constructStorage/constructIdempotent
    -- TODO: separate destroyIdempotent into destroyStorage/destroyIdempotent
    CREATE OR REPLACE PROCEDURE ${fn.constructIdempotent(state).qName}() AS $$
    BEGIN
        CALL safe_create_image_meta_data_type();
        
        CREATE OR REPLACE FUNCTION ${sQR("inspect_image_meta_data")}(provenance text, image bytea) RETURNS ${sQR("image_meta_data")} AS $innerFn$
        from io import BytesIO
        import PIL
        from PIL import Image
        try:
            mem_file = BytesIO()
            mem_file.write(image)
            img = Image.open(mem_file)
            img.verify()
            format = img.format
            width, height = img.size
            sizeBytes = mem_file.getbuffer().nbytes
            img.close()
            return provenance, format, width, height, sizeBytes, True, repr(img)
        except Exception as error:
            return provenance, "unknown", -1, -1, -1, False, repr(error)
        $innerFn$ LANGUAGE plpython3u;
        comment on function ${sQR("inspect_image_meta_data")}(provenance text, image bytea) is 'Given a binary image, detect its format and size';
        
        CREATE OR REPLACE FUNCTION ${sQR("optimize_image")}(provenance text,original_image bytea, optimize_size integer) RETURNS ${sQR("image_content")} AS $innerFn$
        import io
        from io import BytesIO
        from io import StringIO
        import PIL
        from PIL import Image
        import math
        import imagehash
        try:
            optimized_image = original_image
            mem_file = BytesIO()
            mem_file.write(original_image)
            img = Image.open(mem_file)
            img.verify()
            image_format_original = img.format
            image_hash = imagehash.average_hash(Image.open(mem_file))
            mime_type_original = Image.MIME[image_format_original]
            image_file_extension_original = '.'+image_format_original.lower()
            image_width_original, image_height_original = img.size
            image_size_original = mem_file.getbuffer().nbytes
            allowed_images = ['PNG', 'JPEG', 'JPG', 'jpg','png','jpeg','ICO','ico']
            is_transformed = False
            if image_size_original > optimize_size and image_format_original in allowed_images:
                is_transformed = True
                rgb_im = Image.open(mem_file).convert("RGB")
                Qmin, Qmax = 25, 96
                Qacc = -1
                while Qmin <= Qmax:
                    m = math.floor((Qmin + Qmax) / 2)
                    buffer = io.BytesIO()
                    rgb_im.save(buffer, format="JPEG", quality=m)
                    s = buffer.getbuffer().nbytes
                    if s <= optimize_size:
                        Qacc = m
                        Qmin = m + 1
                    elif s > optimize_size:
                        Qmax = m - 1
                image_format = 'JPEG'
                image_file_extension = '.jpeg'
                mime_type = Image.MIME[image_format]
                image_width, image_height = rgb_im.size
                buffer = io.BytesIO()
                if Qacc > -1:
                    rgb_im.save(buffer, format="JPEG", quality=Qacc)
                else:
                    rgb_im.save(buffer, format="JPEG", quality=50)
                size_bytes = buffer.getbuffer().nbytes
                optimized_image = buffer.getvalue()
            else:
                size_bytes = image_size_original
                image_format = image_format_original
                image_file_extension = image_file_extension_original
                mime_type = mime_type_original
                image_width = image_width_original
                image_height = image_height_original
            img.close()
            return provenance,optimized_image,image_format,image_width,image_height,size_bytes,mime_type,image_format_original, image_size_original,image_width_original, image_height_original,image_file_extension_original,mime_type_original,image_hash,is_transformed,True,image_file_extension,repr(img)
        except Exception as error:
            return provenance,original_image,"unknown",-1,-1,-1,"unknown","unknown",-1,-1,-1,"unknown","unknown","unknown",False,False,"unknown",repr(error)
        $innerFn$ LANGUAGE plpython3u;
        comment on function ${sQR("optimize_image")}(provenance text,original_image bytea, optimize_size integer) is 'Given a  compressed binary image, detect its format and size';

        CREATE OR REPLACE FUNCTION ${fn.unitTest(state).qName}() RETURNS SETOF TEXT LANGUAGE plpgsql AS $unitTestFn$
        DECLARE
            imgMD ${sQR("image_meta_data")};
            imgContent ${sQR("image_content")};
        BEGIN 
            RETURN NEXT has_extension('plpython3u');
            RETURN NEXT has_type('image_meta_data');
            RETURN NEXT has_function('inspect_image_meta_data');

            -- The test values were obtained by using BBeaver "advanced copy" functionality from miniflux.icons table
            -- This is a 32x32 PNG file
            imgMD := ${sQR("inspect_image_meta_data")}('bytea://test1valid', decode('89504E470D0A1A0A0000000D494844520000002000000020080300000044A48AC600000300504C544547704C7A3F17CC6527070301B14D1F291716D2722909111C000000070609CE7127172A441531591A2F51CD6923000000CD6B28B34B1F652F0E7430147B431890491BDA7B28572C111B355AC66A27773816AF6124C4682706000D182E51273D60CD6426A5531BC26525192F51283F61A1571E20385C182942112A4F112E578342051F375CDA7A2B3A1709C15F24C15623BE6426C26828CF6727A85D23A74A1E953F1AD25D27B54C20944D1DAD481ED26629C75D2598441DD1752BC67029783413913C199E491EE47D2EC6722ADA7A2EB85522CF6929E481302F1909CE6828C0722EDA7E2EC7722ADD7C2EEE8D33152B4C5C4B40F19135A060222A4063CB6727E0832EF78F2D554A49152E551C345A5B2B0FD3702A10315E162F55A95D22284267112A50EB8B327A3F18DB7923192D4A904D1D8B4A1CB85A19A6521FC76928152E53C871277D53303838442134529C68421210152A3953E2802FA55921B3572112294980411920365827272FC36324DB6D2ABC5B2376502FB5581D74442320293A223F671C32544B4140FFFFFFEB7D2FE97B2EED8331FA9A37FA9C371D355AE7742CE9772EEF8831F28731C7CDD7E06929E46D2AEC7F30DE6027DC6027F59334DF6329DF662AEC8131E5702BF59033355177F18A32E5742DF38E34E26B29FF9631C2C9D4213D65DD622AE7792DFF9E34FB9735DFE2E8755B4AF79434F78B30F08432FE8F303B577D4A6488FF9B30FB8B2D3F4050476185584947294166E06026FC9E37E7762EF79736FFA434E881301F3A616C7C95A8B3C3354B6C7185A0F3F5F7253959FEFEFFE8EAEE73839B163969586C894F6482B9C0CD2F46685467848997AB8D6343909DAFC9D0DAF0822D8C603D4D678A2E3F5EB1BBC92C3853DE7E30445877564E51FBFBFC14356386664AB57A43445979253C5FA5AFBEB37241CB7D3CAF7845F38830EA8833DB8A3C4446523C547893A0B2BF7539E485342D3E5B7B8BA296663C634A43A77042E9EBEFA1ABBA6D5B54E3E6EB6D839F7B4E3D8494AB96673D1D4272965537504547BA602E273E61D5DCE4647690D6DBE3BDC5D24459787F3200DC0000008374524E53001BAD08C11FAE050602C531FCFCC00EA5C7495C2024AC416696509D7813910FB63365C20D55C04CB03C0CF2CA316DD18070B6459A85F8BB64A5E5D27CA0B6128B7DF3C1C6B3D5D737AFD0EC83B2F8786EFD3CA5AAC9D4BFCBF424B652DC8B1CA0FE5DAEB674428D44A2EB8CA82B9CEB288BEF855E8931F745C9ED81AB4F9B9287DB7CB8EE82AE000002964944415438CB6360A002D0331230303466C4AD40A1ABABBBB5D5C9C5278813C495D79408E64651C0D4B56D716BCBC4B6553DA101127211917BF7DE614555D00D929FDED6B6FEDEAEDBBBCFF4ED3FAA8C6A85670B44BE67F5F235079B9B9BF79F90435510B2B875E2AA55BD0F57AEDCB00F28DFBCA0531D5541945452AA3457D18B47F73BF780143CE3AD6057915741F74BE1C59707762D032938C95BAEADBD590D5D81DAD1B30BFA40F207FB162CE8BB74220F21A52429A3A498CBF3BE19099C457647746F4FCFFAFC851F91159CE22D402860EBED99BDFAC391B5C74E1E02C91DDEB871E3DA6F9BD29114CC9E3D77E6DBD3AF373C05C9BF5BB8E9EBF9F3A79F9F934228983977EECCF9EBD63D0187C2719E9C75F3E7AF5ED9EB260B5320B0B367E68A154B1F4342E154966CF6DCD93D6D6DAD8E3005ACE249715C894B1E1C0187C2316506669DDEB6E92D2D56C851C62C2EB67C0D48FED0E6520686B49DD35B5ABBE7D8A0041467EC61B0133A6B809CCC89ADDBB6755BF3232B88E7B90B52F0E5F215550686B239DDDBE6CCE81782CB328A32C4FC023BE1C28FF53AC08415D23D67C68409265069515FBFC0B0F059D7410AD66C3A77A5A941B316283F6F823EC40E7BF7F6F68E1DCBD782C3F84CE7E58B9B7F716B55CD98D7DF6FA60B5620B31DA4E0E62C482CFCBDF4FB4F232783C284FE6953270B83158801E53B96DCBAD1078BA9FF1A0C0CD5F3A64D5D34C914ACC0B6A3A3A37DE9946BB3A02AFE2DAC676028E99FBA68F2244BB002D5295BDBB7AF98EFA5D17975F7AB4F17662DDC50C7C090316DD1E4C993CCC1398553724AFBD215DE420CDCFE09296F3E7FFF398F8F814171DAD42D93B60832838D60B7B07396F60033B592B9F8F82A8B3919185D595858041D3860E10C6330B03303013B8CC14144D606004CE532BC9652AC850000000049454E44AE426082','hex')::bytea);
            RETURN NEXT is(imgMD.provenance, 'bytea://test1valid', 'Test image 1 should have provenance');
            RETURN NEXT is(imgMD.image_is_valid, true, 'Test image 1 should be valid');
            RETURN NEXT is(imgMD.image_format, 'PNG', 'Test image 1 should be PNG format');
            RETURN NEXT is(imgMD.image_width, 32, 'Test image 1 should be 32 pixels wide');
            RETURN NEXT is(imgMD.image_height, 32, 'Test image 1 should be 32 pixels high');

            -- This is a 16x16 ICO file
            imgMD := ${sQR("inspect_image_meta_data")}('bytea://test2valid', decode('0000010001001010000001002000680400001600000028000000100000002000000001002000000000000004000000000000000000000000000000000000FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00CBBA93A3D2C5A38AFFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00C0AC7CBFC8B78DA7FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FDFDFC03F1EDE328FFFFFF00FFFFFF00C0AC7CBFC8B78DA7FFFFFF00FFFFFF00EFEADF32FEFDFD03FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00E2D9C457AC9252F6FEFEFD01FFFFFF00C0AC7CBFC8B78DA7FFFFFF00F8F5F019A98E4CFDEAE3D344FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00E0D6BE5EAA8F4FFCFDFDFC03FFFFFF00C0AC7CBFC8B78DA7FFFFFF00F6F4ED1FA98E4CFFE8E1D048FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00DFD6BE5EAA8F4FFCFDFDFC03FFFFFF00C0AC7CBFC8B78DA7FFFFFF00F6F4ED1FA98E4CFFE8E1D048FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00E0D6BE5EAA8F4FFCFDFDFC03FFFFFF00C0AC7CBFC8B78DA7FFFFFF00F6F4ED1FA98E4CFFE8E1D048FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00E0D6BE5EAA8F4FFCFDFDFC03FFFFFF00C0AC7CBFC8B78DA7FFFFFF00F6F4ED1FA98E4CFFE8E1D048FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00DFD6BE5EAA8F4FFCFDFDFC03FFFFFF00C0AC7CBFC8B78DA7FFFFFF00F6F4ED1FA98E4CFFE8E1D048FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00DFD6BE5EAA8F4FFCFDFDFC03FFFFFF00C0AC7CBFC8B78DA7FFFFFF00F6F4ED1FA98E4CFFE8E1D048FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00DFD6BE5EAA8F4FFCFDFDFC03FFFFFF00C0AC7CBFC8B78DA7FFFFFF00F6F4ED1FA98E4CFFE8E1D048FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00DFD6BE5EAA8F4FFCFDFDFC03FFFFFF00C0AC7CBFC8B78DA7FFFFFF00F6F4ED1FA98E4CFFE8E1D048FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00E2D9C457AC9252F6FEFEFD01FFFFFF00C0AC7CBFC8B78DA7FFFFFF00F8F5F019A98E4CFDEAE3D344FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FDFDFC03F1EDE328FFFFFF00FFFFFF00C0AC7CBFC8B78DA7FFFFFF00FFFFFF00EFEADF32FEFDFD03FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00C0AC7CBFC8B78DA7FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00CBBA93A3D2C5A38AFFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FE7F0000FE7F0000FE7F0000F66F0000F66F0000F66F0000F66F0000F66F0000F66F0000F66F0000F66F0000F66F0000F66F0000FE7F0000FE7F0000FE7F0000','hex')::bytea);
            RETURN NEXT is(imgMD.image_is_valid, true, 'Test image 2 should be valid');
            RETURN NEXT is(imgMD.image_format, 'ICO', 'Test image 2 should be ICO format');
            RETURN NEXT is(imgMD.image_width, 16, 'Test image 2 should be 32 pixels wide');
            RETURN NEXT is(imgMD.image_height, 16, 'Test image 2 should be 32 pixels high');

            -- This is an invalid image
            imgMD := ${sQR("inspect_image_meta_data")}('bytea://test3invalid', decode('F17CC6527070301B14D1F291716D2722909111','hex')::bytea);
            RETURN NEXT is(imgMD.image_is_valid, false, 'Test image 3 should be invalid');
            RETURN NEXT is(imgMD.image_format, 'unknown', 'Test image 3 format should be unknown');
        
            -- This image can't optimize (original size < The specified size)
            imgContent := ${sQR("optimize_image")}('bytea://test1valid', decode('89504E470D0A1A0A0000000D494844520000002000000020080300000044A48AC600000300504C544547704C7A3F17CC6527070301B14D1F291716D2722909111C000000070609CE7127172A441531591A2F51CD6923000000CD6B28B34B1F652F0E7430147B431890491BDA7B28572C111B355AC66A27773816AF6124C4682706000D182E51273D60CD6426A5531BC26525192F51283F61A1571E20385C182942112A4F112E578342051F375CDA7A2B3A1709C15F24C15623BE6426C26828CF6727A85D23A74A1E953F1AD25D27B54C20944D1DAD481ED26629C75D2598441DD1752BC67029783413913C199E491EE47D2EC6722ADA7A2EB85522CF6929E481302F1909CE6828C0722EDA7E2EC7722ADD7C2EEE8D33152B4C5C4B40F19135A060222A4063CB6727E0832EF78F2D554A49152E551C345A5B2B0FD3702A10315E162F55A95D22284267112A50EB8B327A3F18DB7923192D4A904D1D8B4A1CB85A19A6521FC76928152E53C871277D53303838442134529C68421210152A3953E2802FA55921B3572112294980411920365827272FC36324DB6D2ABC5B2376502FB5581D74442320293A223F671C32544B4140FFFFFFEB7D2FE97B2EED8331FA9A37FA9C371D355AE7742CE9772EEF8831F28731C7CDD7E06929E46D2AEC7F30DE6027DC6027F59334DF6329DF662AEC8131E5702BF59033355177F18A32E5742DF38E34E26B29FF9631C2C9D4213D65DD622AE7792DFF9E34FB9735DFE2E8755B4AF79434F78B30F08432FE8F303B577D4A6488FF9B30FB8B2D3F4050476185584947294166E06026FC9E37E7762EF79736FFA434E881301F3A616C7C95A8B3C3354B6C7185A0F3F5F7253959FEFEFFE8EAEE73839B163969586C894F6482B9C0CD2F46685467848997AB8D6343909DAFC9D0DAF0822D8C603D4D678A2E3F5EB1BBC92C3853DE7E30445877564E51FBFBFC14356386664AB57A43445979253C5FA5AFBEB37241CB7D3CAF7845F38830EA8833DB8A3C4446523C547893A0B2BF7539E485342D3E5B7B8BA296663C634A43A77042E9EBEFA1ABBA6D5B54E3E6EB6D839F7B4E3D8494AB96673D1D4272965537504547BA602E273E61D5DCE4647690D6DBE3BDC5D24459787F3200DC0000008374524E53001BAD08C11FAE050602C531FCFCC00EA5C7495C2024AC416696509D7813910FB63365C20D55C04CB03C0CF2CA316DD18070B6459A85F8BB64A5E5D27CA0B6128B7DF3C1C6B3D5D737AFD0EC83B2F8786EFD3CA5AAC9D4BFCBF424B652DC8B1CA0FE5DAEB674428D44A2EB8CA82B9CEB288BEF855E8931F745C9ED81AB4F9B9287DB7CB8EE82AE000002964944415438CB6360A002D0331230303466C4AD40A1ABABBBB5D5C9C5278813C495D79408E64651C0D4B56D716BCBC4B6553DA101127211917BF7DE614555D00D929FDED6B6FEDEAEDBBBCFF4ED3FAA8C6A85670B44BE67F5F235079B9B9BF79F90435510B2B875E2AA55BD0F57AEDCB00F28DFBCA0531D5541945452AA3457D18B47F73BF780143CE3AD6057915741F74BE1C59707762D032938C95BAEADBD590D5D81DAD1B30BFA40F207FB162CE8BB74220F21A52429A3A498CBF3BE19099C457647746F4FCFFAFC851F91159CE22D402860EBED99BDFAC391B5C74E1E02C91DDEB871E3DA6F9BD29114CC9E3D77E6DBD3AF373C05C9BF5BB8E9EBF9F3A79F9F934228983977EECCF9EBD63D0187C2719E9C75F3E7AF5ED9EB260B5320B0B367E68A154B1F4342E154966CF6DCD93D6D6DAD8E3005ACE249715C894B1E1C0187C2316506669DDEB6E92D2D56C851C62C2EB67C0D48FED0E6520686B49DD35B5ABBE7D8A0041467EC61B0133A6B809CCC89ADDBB6755BF3232B88E7B90B52F0E5F215550686B239DDDBE6CCE81782CB328A32C4FC023BE1C28FF53AC08415D23D67C68409265069515FBFC0B0F059D7410AD66C3A77A5A941B316283F6F823EC40E7BF7F6F68E1DCBD782C3F84CE7E58B9B7F716B55CD98D7DF6FA60B5620B31DA4E0E62C482CFCBDF4FB4F232783C284FE6953270B83158801E53B96DCBAD1078BA9FF1A0C0CD5F3A64D5D34C914ACC0B6A3A3A37DE9946BB3A02AFE2DAC676028E99FBA68F2244BB002D5295BDBB7AF98EFA5D17975F7AB4F17662DDC50C7C090316DD1E4C993CCC1398553724AFBD215DE420CDCFE09296F3E7FFF398F8F814171DAD42D93B60832838D60B7B07396F60033B592B9F8F82A8B3919185D595858041D3860E10C6330B03303013B8CC14144D606004CE532BC9652AC850000000049454E44AE426082','hex')::bytea,20000);
            RETURN NEXT is(imgContent.is_transformed, false, 'Test image can not be transformed');
            
            -- This unsupported image format can't be optimized
            
            imgContent := ${sQR("optimize_image")}('bytea://test1valid', decode('3C3F786D6C2076657273696F6E3D22312E302220656E636F64696E673D225554462D3822207374616E64616C6F6E653D226E6F223F3E0A3C73766720786D6C6E733A64633D22687474703A2F2F7075726C2E6F72672F64632F656C656D656E74732F312E312F2220786D6C6E733A63633D22687474703A2F2F6372656174697665636F6D6D6F6E732E6F72672F6E73232220786D6C6E733A7264663D22687474703A2F2F7777772E77332E6F72672F313939392F30322F32322D7264662D73796E7461782D6E73232220786D6C6E733A7376673D22687474703A2F2F7777772E77332E6F72672F323030302F7376672220786D6C6E733D22687474703A2F2F7777772E77332E6F72672F323030302F7376672220786D6C6E733A786C696E6B3D22687474703A2F2F7777772E77332E6F72672F313939392F786C696E6B222076657273696F6E3D22312E31222077696474683D2235373022206865696768743D22373230223E0A203C7061746820643D226D203135382E3337352C312E36353632352063202D332E363139332C302E31313233313932202D372E35313731352C312E34343933323636202D31312E393337352C342E393337352043203133352E36313035342C322E34313734343936203132352E31313034312C302E39363635363132203131352E37313837352C392E3436383735203130312E32323438392C372E353837393932322039362E3530383436312C31312E3436393439342039322E393337352C31362038392E3735343935332C31352E3933343133352036392E3131383635322C31322E37323739332035392E36353632352C32362E38343337352033352E3837343630322C32342E3033303332392032382E3335393437322C34302E3833313632352033362E3837352C35362E352063202D342E3835363931312C372E353138393535202D392E3838393530332C31342E39343732323620312E34363837352C32392E3238313235202D342E3031383030362C372E393833353134202D312E3532373433312C31362E363434303320372E393337352C32372E313235202D322E3439373835372C31312E3232323620322E3431323037372C31392E31343038362031312E32313837352C32352E33313235202D312E36343730392C31352E33353735362031342E3038333530352C32342E32383734332031382E37383132352C32372E343638373520312E3830333637372C382E393438363820352E35363239312C31372E333932372032332E35333132352C32322E3036323520322E39363332332C31332E333336312031332E37363230362C31352E36333930362032342E32313837352C31382E34333735202D33342E3536313932392C32302E3038393534202D36342E32303036372C34362E3532323636202D36342C3131312E333735206C202D352E303632352C392E303331323520432031352E3333373838322C3335302E3639363034202D32302E3331363534372C3432382E31363030312033352E343337352C3439312E313235206320332E3634313837312C31392E373038333820392E3734393538392C33332E38363339362031352E313837352C34392E353331323520382E3133333833342C36332E31333035382036312E32313736332C39322E36393136312037352E32313837352C39362E313837352032302E35313635332C31352E36323831322034322E33363831382C33302E34353637322037312E393337352C34302E38343337352032372E38373531352C32382E37343934362035382E30373338382C33392E373036342038382E343337352C33392E3638373520302E34343531352C2D322E38652D3420302E38393835332C302E30303520312E33343337352C302033302E33363336332C302E303138392036302E35363233352C2D31302E39333830342038382E343337352C2D33392E363837352032392E35363933322C2D31302E33383730332035312E34323039372C2D32352E32313536332037312E393337352C2D34302E38343337352031342E30303131322C2D332E34393538392036372E30383439322C2D33332E30353639322037352E32313837352C2D39362E3138373520352E34333739312C2D31352E36363732392031312E35343536322C2D32392E38323238372031352E313837352C2D34392E35333132352035352E37353430342C2D36322E39363439392032302E30393936312C2D3134302E3432383936202D31392E35333132352C2D3136342E3533313235204C203531332E37352C3331372E35363235206320302E32303036372C2D36342E3835323334202D32392E34333830372C2D39312E3238353436202D36342C2D3131312E3337352031302E34353636392C2D322E37393834342032312E32353535322C2D352E313031342032342E32313837352C2D31382E343337352031372E39363833342C2D342E363639382032312E37323735382C2D31332E31313338322032332E35333132352C2D32322E3036323520342E36393737352C2D332E31383133322032302E34323833342C2D31322E31313131392031382E37383132352C2D32372E343638373520382E38303636382C2D362E31373136342031332E37313636312C2D31342E303839392031312E32313837352C2D32352E3331323520392E34363439342C2D31302E34383039372031312E393535352C2D31392E31343134383720372E393337352C2D32372E3132352043203534362E37393537352C37312E343437323236203534312E37363331362C36342E303138393535203533362E39303632352C35362E35203534352E34323137382C34302E383331363235203533372E39303636352C32342E303330333239203531342E3132352C32362E3834333735203530342E363632362C31322E3732373933203438342E303236332C31352E393334313335203438302E38343337352C3136203437372E32373237392C31312E343639343934203437322E35353633362C372E353837393932203435382E303632352C392E3436383735203434382E36373038342C302E3936363536313332203433382E31373037312C322E3431373435203432372E33343337352C362E3539333735203431342E34383435352C2D332E35353336363331203430352E39373134392C342E353830343534203339362E32352C372E3635363235203338302E36373631352C322E353638343732203337372E31313639382C392E35333731353738203336392E34363837352C31322E333735203335322E343933352C382E37383639323338203334372E33333331352C31362E353938353332203333392E313837352C32342E3834333735206C202D392E34363837352C2D302E313837352063202D32352E36313035342C31352E303933313135202D33382E33333337382C34352E383235353031202D34322E38343337352C36312E363235202D342E35313230362C2D31352E383031393739202D31372E32303634372C2D34362E353334353432202D34322E383132352C2D36312E363235206C202D392E34363837352C302E313837352043203232362E343438312C31362E353938353332203232312E32383737352C382E37383639323335203230342E333132352C31322E333735203139362E36363432372C392E35333731353833203139332E313035312C322E35363834373239203137372E35333132352C372E36353632352063202D362E33373937332C2D322E30313834393131202D31322E32343636372C2D362E32313434323736202D31392E31353632352C2D36207A22207374796C653D2266696C6C3A2330303030303022202F3E0A203C7061746820643D226D203130372E33393138342C36382E30353535383320632036372E39343736372C33352E303331333537203130372E34343638392C36332E333638393637203132392E30383731372C38372E353034343637202D31312E30383233352C34342E3431373539202D36382E38393633382C34362E3434343634202D39302E30333535392C34352E313938353820342E33323834322C2D322E303134373420372E39333938382C2D342E343237373820392E32323035312C2D382E3133353734202D352E33303434392C2D332E3736393831202D32342E31313238392C2D302E3339373139202D33372E32343336332C2D372E373734313620352E30343430372C2D312E303434393920372E34303334382C2D322E303633303220392E37363238392C2D352E3738353432202D31322E34303537312C2D332E39353637202D32352E37363836322C2D372E3336363432202D33332E3632373734362C2D31332E393231313620342E3234313235332C302E3035323420382E3230313135362C302E393438382031332E3734303336362C2D322E3839323731202D31312E3131313639342C2D352E3938383139202D32322E3936393130382C2D31302E3733333531202D33322E31383133392C2D31392E383837333820352E3734353231332C2D302E31343036332031312E3933393435322C2D302E303536382031332E3734303337312C2D322E3136393533202D31302E31373034342C2D362E3330303638202D31382E3735313234322C2D31332E3330373837202D32352E3835333539322C2D32302E393732313520382E3033393937392C302E39373035322031312E3433353238342C302E31333437382031332E3337383738322C2D312E3236353536202D372E3638373739352C2D372E3837343139202D31372E3431373535392C2D31342E3532333139202D32322E3035363931312C2D32342E323236343420352E3936393630362C322E3035373438342031312E3433313234392C322E38343530362031352E33363735322C2D302E313830373935202D322E3631323336352C2D352E383933343533202D31332E3830353431332C2D392E333639363138202D32302E3234383936372C2D32332E31343136373620362E3238343335392C302E3630393337372031322E3934393630362C312E3337313130382031342E3238323735332C3020432036312E3830323036382C35382E3531373334362035362E3739363931392C35312E3833353838352035312E3838373937382C34342E3931333930362036352E3333383032312C34342E3731343137372038352E3731353733342C34342E3936363235332038342E3739323534392C34332E3832393134206C202D382E33313635342C2D382E34393733333520632031332E3133373631372C2D332E3533373234312032362E3538303635312C302E3536383136342033362E3333393636312C332E36313538383720342E33383138362C2D332E343537363831202D302E303737362C2D372E3832393938202D352E34323338332C2D31322E3239343031352031312E31363439362C312E3439303634362032312E32353338322C342E3035373338392033302E33373334352C372E35393333363220342E38373233382C2D342E333939333239202D332E31363338392C2D382E373938363538202D372E30353039382C2D31332E3139373938372031372E32343933362C332E3237323536382032342E35353731362C372E38373036382033312E38313938312C31322E343734383120352E32363933352C2D352E30353037393920302E33303136362C2D392E333433323939202D332E323534332C2D31332E3734303337312031332E30303536362C342E3831373034382031392E37303437382C31312E3033353535312032362E37353735362C31372E31373534363320322E33393131392C2D332E32323730353320362E30373439342C2D352E35393234303820312E36323731352C2D31332E33373837383120392E32333431362C352E3332323732352031362E31383932362C31312E35393530362032312E33333337342C31382E36323138313720352E37313333362C2D332E36333739343120332E34303338372C2D382E36313330323320332E34333530392C2D31332E31393739383720392E35393636352C372E3830363531362031352E36383638372C31362E31313339352032332E31343136382C32342E32323634343320312E35303136392C2D312E30393334333720322E38313636312C2D342E383031373120332E39373734372C2D31302E3636363836372032322E38393533392C32322E3231313831352035352E32343539312C37382E31353832343120382E33313635342C3130302E3334303836312043203230372E39353032382C3130392E3935373238203136302E32353239322C38362E303136393039203130372E33393138342C36382E303535353833207A22207374796C653D2266696C6C3A2337356139323822202F3E0A203C7061746820643D224D203436372E39323438372C36382E3035353538332043203339392E393737322C3130332E3038363934203336302E34373739382C3133312E3432343535203333382E383337372C3135352E353630303520632031312E30383233352C34342E34313735392036382E38393633382C34362E34343436342039302E30333535392C34352E3139383538202D342E33323834322C2D322E3031343734202D372E39333938382C2D342E3432373738202D392E32323035312C2D382E313335373420352E33303434392C2D332E37363938312032342E31313238392C2D302E33393731392033372E32343336332C2D372E3737343136202D352E30343430372C2D312E3034343939202D372E34303334382C2D322E3036333032202D392E37363238392C2D352E37383534322031322E34303537312C2D332E393536372032352E37363836322C2D372E33363634322033332E36323737352C2D31332E3932313136202D342E32343132362C302E30353234202D382E32303131362C302E39343838202D31332E37343033372C2D322E38393237312031312E31313136392C2D352E39383831392032322E39363931312C2D31302E37333335312033322E31383133392C2D31392E3838373338202D352E37343532312C2D302E3134303633202D31312E39333934352C2D302E30353638202D31332E37343033372C2D322E31363935332031302E31373034342C2D362E33303036382031382E37353132342C2D31332E33303738372032352E38353335392C2D32302E3937323135202D382E30333939382C302E3937303532202D31312E34333532382C302E3133343738202D31332E33373837382C2D312E323635353620372E36383737392C2D372E38373431392031372E34313735362C2D31342E35323331392032322E30353639312C2D32342E3232363434202D352E39363936312C322E303537343834202D31312E34333132352C322E3834353036202D31352E33363735322C2D302E31383037393520322E36313233372C2D352E3839333435332031332E38303534312C2D392E3336393631382032302E32343839372C2D32332E313431363736202D362E32383433362C302E363039333737202D31322E39343936312C312E333731313038202D31342E32383237362C3020322E39323233312C2D31312E38383835363320372E39323734362C2D31382E3537303032342031322E383336342C2D32352E343932303033202D31332E34353030342C2D302E313939373239202D33332E38323737352C302E3035323335202D33322E39303435372C2D312E303834373636206C20382E33313635342C2D382E3439373333352063202D31332E31333736322C2D332E353337323431202D32362E35383036352C302E353638313634202D33362E33333936362C332E363135383837202D342E33383138362C2D332E34353736383120302E303737362C2D372E383239393820352E34323338332C2D31322E323934303135202D31312E31363439362C312E343930363436202D32312E32353338322C342E303537333839202D33302E33373334352C372E353933333632202D342E38373233382C2D342E33393933323920332E31363338392C2D382E37393836353820372E30353039382C2D31332E313937393837202D31372E32343933362C332E323732353638202D32342E35353731362C372E3837303638202D33312E38313938312C31322E3437343831202D352E32363933352C2D352E303530373939202D302E33303136362C2D392E33343332393920332E323534332C2D31332E373430333731202D31332E30303536362C342E383137303438202D31392E37303437382C31312E303335353531202D32362E37353735362C31372E313735343633202D322E33393131392C2D332E323237303533202D362E30373439342C2D352E353932343038202D312E36323731352C2D31332E333738373831202D392E32333431362C352E333232373235202D31362E31383932362C31312E3539353036202D32312E33333337342C31382E363231383137202D352E37313333362C2D332E363337393431202D332E34303338372C2D382E363133303233202D332E34333530392C2D31332E313937393837202D392E35393636352C372E383036353136202D31352E36383638372C31362E3131333935202D32332E31343136382C32342E323236343433202D312E35303136392C2D312E303933343337202D322E38313636312C2D342E3830313731202D332E39373734372C2D31302E363636383637202D32322E38393533392C32322E323131383135202D35352E32343539312C37382E313538323431202D382E33313635342C3130302E3334303836312033392E39313837372C2D33322E39343731362038372E36313631332C2D35362E383837353331203134302E34373732312C2D37342E383438383537207A22207374796C653D2266696C6C3A2337356139323822202F3E0A203C7061746820643D226D203336352E323034362C3532312E383439333720612037312E3935363135342C36362E353332333138203020312031202D3134332E39313233312C302037312E3935363135342C36362E353332333138203020312031203134332E39313233312C30207A22207472616E73666F726D3D226D617472697828312E3133313130372C302C302C312E313238303439372C2D34332E3133393133352C2D36382E3331303938332922207374796C653D2266696C6C3A2362633131343222202F3E0A203C7061746820643D226D203236322E38343039312C3237362E363437373420612036312E3837352C32382E313235203020312031202D3132332E37352C302036312E3837352C32382E313235203020312031203132332E37352C30207A22207472616E73666F726D3D226D617472697828302E37363734313638342C2D312E313631333131322C322E3137313131352C312E343232343336382C2D3536302E38383835382C3231372E36383835392922207374796C653D2266696C6C3A2362633131343222202F3E0A203C7061746820643D226D203236322E38343039312C3237362E363437373420612036312E3837352C32382E313235203020312031202D3132332E37352C302036312E3837352C32382E313235203020312031203132332E37352C30207A22207472616E73666F726D3D226D6174726978282D302E37363734313638342C2D312E313631333131322C2D322E3137313131352C312E343232343336382C313133342E383238382C3231332E36383835392922207374796C653D2266696C6C3A2362633131343222202F3E0A203C7061746820643D224D2037322E3931303235332C3334322E303837382043203130392E33323434372C3333322E33333038382038352E3230313834352C3439322E37323433312035352E3537363837312C3437392E35363335372032322E3939303130332C3435332E33353038392031322E3439333830312C3337362E35383831342037322E3931303235332C3334322E30383738207A22207374796C653D2266696C6C3A2362633131343222202F3E0A203C7061746820643D226D203439332E36373832382C3334302E303837382063202D33362E34313432322C2D392E3735363932202D31322E323931362C3135302E36333635312031372E33333333382C3133372E34373537372033322E35383637372C2D32362E32313236382034332E30383330372C2D3130322E3937353433202D31372E33333333382C2D3133372E3437353737207A22207374796C653D2266696C6C3A2362633131343222202F3E0A203C7061746820643D226D203336392E39373135382C3232302E3635333420632036322E38333438362C2D31302E3631303133203131352E31313539342C32362E3732323239203131332E30313133382C39342E3835373936202D322E30363639332C32362E3132313132202D3133362E31353837322C2D39302E3936393037202D3131332E30313133382C2D39342E3835373936207A22207374796C653D2266696C6C3A2362633131343222202F3E0A203C7061746820643D224D203139362E33353937352C3231382E363533342043203133332E35323438392C3230382E30343332372038312E32343338312C3234352E33373536392038332E33343833372C3331332E35313133362038352E343135332C3333392E3633323438203231392E35303730392C3232322E3534323239203139362E33353937352C3231382E36353334207A22207374796C653D2266696C6C3A2362633131343222202F3E0A203C7061746820643D226D203238362E36313933322C3230322E37353536382063202D33372E35303235392C2D302E3937353438202D37332E34393534382C32372E3833343138202D37332E35383135382C34342E3534343433202D302E31303436322C32302E33303432362032392E363531322C34312E30393236362037332E38333732362C34312E36323033352034352E31323330352C302E33323332312037332E39313536312C2D31362E36343034392037342E303631312C2D33372E353934303920302E31363438342C2D32332E3733393936202D34312E30333837392C2D34382E3933373434202D37342E33313637382C2D34382E3537303639207A22207374796C653D2266696C6C3A2362633131343222202F3E0A203C7061746820643D226D203238382E39303933372C3631392E313136373520632033322E36393734342C2D312E34323731312037362E35373038332C31302E35333139362037362E363536382C32362E333935393820302E353432372C31352E34303532202D33392E37383936392C35302E3231303535202D37382E38323633342C34392E3533373635202D34302E34323732392C312E3734333931202D38302E30363930382C2D33332E3131353539202D37392E35343935312C2D34352E3139383539202D302E36303530362C2D31372E37313539332034392E3232362C2D33312E35343739362038312E37313930352C2D33302E3733353034207A22207374796C653D2266696C6C3A2362633131343222202F3E0A203C7061746820643D226D203136382E31333837342C3532352E313033363920632032332E323739312C32382E30343537332033332E38393036362C37372E33313839392031342E34363335352C39312E3834333533202D31382E33373931372C31312E3038373834202D36332E30313232382C362E3532313632202D39342E3733363233372C2D33392E3035313537202D32312E3339353035322C2D33382E3234313638202D31382E3633373538342C2D37372E3135363633202D332E3631353838372C2D38382E35383932342032322E3436343432342C2D31332E36383432392035372E3137333432342C342E37393930322038332E3838383537342C33352E3739373238207A22207374796C653D2266696C6C3A2362633131343222202F3E0A203C7061746820643D226D203430352E303230392C3531362E32313137372063202D32352E31383638322C32392E3530313635202D33392E32313232372C38332E3330393531202D32302E38333738352C3130302E363432382031372E35363832382C31332E34363336312036342E373239322C31312E35383136322039392E35363536362C2D33362E37353537342032352E32393539392C2D33322E34363437312031362E38323031332C2D38362E363832323520322E33373037372C2D3130312E3037353131202D32312E34363430382C2D31362E3630323133202D35322E32373639312C342E3634343839202D38312E30393835382C33372E3138383035207A22207374796C653D2266696C6C3A2362633131343222202F3E0A3C2F7376673E0A','hex')::bytea,6000);
            RETURN NEXT is(imgContent.is_transformed, false, 'Test image can not be transformed');

            imgContent := ${sQR("optimize_image")}('bytea://test1valid', decode('FFD8FFE000104A46494600010100000100010000FFDB00840009060713121115101113151615151817181918171717191716181A2018171A181819191D2820191E271B191821312125292D2E2E2E191F3338332C37292D302B010A0A0A0E0D0E1A10101B2F251F252D362D2D2D2D2D2D352D2D2D2D2F2D322B302F2D2D2D352D2D2D2D2B2F372D2F2D2B2D2D2D2D2F2D2F2D2D2D2D2D2D2D2F2DFFC000110800A8012C03012200021101031101FFC4001C0001000105010100000000000000000000000301020405060708FFC40042100002010303020306030702050109000001021100032104123141510522610613327181910742A114235262B1C1F072D1338292B2F10815253443637383A2E1FFC4001A010101010101010100000000000000000000010203040506FFC4002D110002020103030107040300000000000000010211210312310441F0711322516181C1E11415A1B105D1F1FFDA000C03010002110311003F00F10354AA9AA5681434A52A014A52805294A8050D28680A5294A014A52805294A014A52805294A014A52805294A014A52805294A014AAD52805294A014A52805294A014A5280BEA94A5505294A500A52940294A540294A5014A5569405294A500A52940294A500A52940294A500A52940294AAD00A52940294A5014A5569405294A500A52940294A501755294AA05294A014A52A014A52805294A014A5280A52AB4A0294A52805294A014A528052955A02955AEBEC7B0B72D694EBF5FBACD91016D81FBFBA5BE10AA7080E72D9004ED35AE1E37EEFF00F85B36ACC7E62A2EDEED3EF2E03B4FFF006C2735681ACD1F85DFBA26D59BB707744661FA0ACD5F6535E46E1A2D511DFDC5D8FF00B6A0D578A5EBDFF1AEDCB9FEB766FF00B89ACFF677C4B5166F29D1BDC4BA48816E7CC7B32F0C3E62AED06A359E1F76CE2F5AB96C9FE3465FFB856357D83ECDEAB53774C9FB6DA5170A8DC04104F5956E3F519AD4F8F7E1AF85EB27769C5AB867CF647BA693C9DA06C7F995351A07CA94AF4AF6DBF07B57A30D7B4E7F69B03276AC5D41FCC99DC008CAFA9802BCD6A014A5280552AB4A0294A52805294A02B4A52A814A52A014A52805294A014A52805294A014A52801AA5569405294A500A52AA280BAD5A2CC1541666200004924E00007249E95EF5F86DF8669A50BA9D5A87D4982A872B63B7A33FAF03A71275BF821EC5E07895E5966916011F08E1AE7CCE40F493D457AEEBAF0B7FBA43E720163FC0A67F53040F913D20E920717F88BE08FADB696167C8DBC9C6DDDC0569209C4F131D6BCA759F86BAA927DE69C0FF53FF6B75EBFE37E2BB576AC003FC35C1F88FB4441E6B7EA4B38ABBEC16B04ED16DC0F88ADC0368192C43ED2444F13C57AEFE1F7B29A7D0287C5CD411E6B847139DA80F038CF263A5721A7F6A08209830448EE3A8FB56F7C37C5F680A5C36D3B27B81F0B1FF526D6FAD4490B3D56C6AAB616DC119AE1FC37C4E6BA2D1EB28D14DBDC04025731F97FDABC8FF15FF0C6D5F46D7E89425EF8DD17E0BD39903F2B9EFC13CC735EB766ECD6368DA2E5DB060810EA3F92E4E0E7F8D6E7D205601F173290608823041E4552BD7BF1BFD82F70FF00FB434CBFBB73FBD51F949FCF1EA79FA7A9AF21A3405294A80552AB4A0294AAD2805294A014A52805294A014A52805294A014A52805294A014A52805294A015B5F65BC18EB357674AA63DE3413D90799CFCC2826B555DEFE13936AE5FD52E5D45AB16F8F8EFB6489EA12DBD54AD83E85B3A8B5A4B5B5509169045BB6B3B514601E8B8189226315A8D66AFC85C904BF989064490383DA200F402B0FF00107C5D749A55B4305F9EB3393BA799E093DEB94F07F170FA141BA4DA9B27324FBBF2A927D53637FCD5BAAC99B30BDA9F138915E75AFD5962735B6F6835DB98E6B9E6135E69EADB08BAD6A08ADC58F175554DEC14B2C1C4994242B1F4D842FF00F8EB437182893FF9AD75C72C64D5836CB47B1F8078AF66571DD4CFDC74AEE3C33C4418CD7CD5A6D63DB32AC47F9FA7D2BB3F677F101ED902F8DC2467D3AC1E418E27749EC2BB6E147D0FA3D66249C0EBDBE755D6BDEF789A9B0BBC223ABDA9DAF755B63029380CA54C0689DCC2579AE4BC0B5E2E65867A0CED181C4C16EB9201CF02BB2D16A6629CE4A53C4ADD9D768EE2987B771581041041182AC0C323022083041AF92FDA4F0B3A5D55DD3F215BCA72251806439039522BEB1F18D33A86D45805988FDEDA1FFCE502257B5D50307F30F29FCA57C4BFF501E0A2D5FD26A1462ED9F767FD56A33FF4BA8FF96A7607945294A805294A014A5280AC5576D4BEEBF5AB8586159DC4B20DB548A9DAD751F2AA2A0A6E1643148AC80A226AC503AD2C590C52A6D955DA2AD8B218AA56400315194A58B23A54CB6898F5AB02D2C1652A5298AA05A58B23A54AB6A6A46D3102483FDA9B914C6A54BEEF9AAAD92660714B4086BD43F0A55458527F3EBEC83CFE54723F535E646DD767ECA6A5D74178DBF8AC6AAC5DFA325D5FFB957EF5A8C92647C1D67E3BEBA6EA203C0AE0BD97F1665172C64878619C02B8627E6BFAA8EF54F6B7C6DF5777DE5CE6A4F0DD08B7656E1F89C6EF929F847D479BFE61DAB1ADAA9448887567399FB13FD2A10077FD0FFB565C55EA95E0DE539BD4DEDC67A0E2A1AD878B6936B6E1F0B7E86B5F5EF834E29A28AB9391F3154ABAD2CB01EA2A83DBBC135F047C971DB1DABBDF0BD548AF23F0FBDB587A4577FE05AB915C3A7D752C193D074976457987FEA1AD06F0DD3DCEAB7D44FA35BB84FEAA2BD0BC3AF579FF00E3F3FF00EEDB16C727509F65B7767FA8AF4B347CF54A9DAC10248EA47DA3FDC550D9220C60F07BD6772210D2A5F767B7F9C55E346D1201398C0EB4DC8A63D2A75D23981B4E71570D21EB8A9B90362DA3652E58405022460CF41D2620D64DDB2764907040240F28580707A98DD5EB27C2F6F90202A5048CE465403FAD5355E1A3DDBA05010050B1D6249FAE00FA915F9FFDD136BDD38B9D1E4B7B4A145B5DB9B80999C10C5B6FF4158D774910B112244F3F28F599AF646F672CB8DC42EEDDB81DA36ED3E52BFF0049FBCF7AC5B7ECBD9DDC2864206E19300C193C185813F4ADC7FCA452B2EE3C9751E1E56173239071031DFD6454BA6D1A44B2F53898ED8FB4FDABD3F53ECDDB687272719CF595F918EDD85407D9F464D800DDE64762258F9A330066233D6066B5FB9C5AC995AA8F375D2951000699E391899FB5437B4E704768E38E867B67FAD7A3D9F6651598905DB72CC980018900018EDFE6320FB3D6C952A3681E46924EF18DA48E0C6C3C673557F9285E0BBD1E6C9E1E36CCCFA012441C83F4AAEA2C222989DCAE071C8CCE7D238F5AF4FF0009F03B5B882815ADAF55804124127A998EBF3A8F57E0565D426C5255A086F877C16632073001F99E335575D6FBD1ADC8F2AB6B1903D40E9DB1F3AB868B70907A811C913D7D44D7A11F6490892849862B323226240322600FBD5DA3F0355D304651B9A577ED92537608CE0F2467AD75975D15EA1491E73A8D09532CBB4623B11C4FD6A896548320CE0FD3A8AF43F14F0C841776EE84DBB1F2C8CA36166FB667A8AD7BF86DB16C6DB782E1549F8C3100A9324088893315575A9E0B67216B463CA4E167323A4E2B22C5A23CCC254B40F433FA7FFCAECAFF00845BB8C364008B0C09F84831224CC06333C6462AED2780A95F70EA4172D9E60CE33C1C29EBD077AC4BAC4D649B8E17F6393E6951983D0F39FB8AC84D24216E08600823E441FACC57677BC0C45C620840F30D858398C70A27247106ACD3F8428702EED3E6DB3C440DC2233131C77A7EB2D58DC71BAFD021B87DD82A009DAC738E735DAFE1668C26A1D2EAAB5ABF6CA9060A9E428604467CC00F5A87C47C1C3DC37001B083723BA9C853F984E66389A786F86DC5F3872AC1B7A2C180C841912609DA01FEFCD6A3D6524EF8E4D265FED9FE1D7BBB86EE9DC7BA246E473E6B6BF98AB9F880127CD9C753CEA7C69F38C7A76F4FA715EB1E21AA176C2DD008DCB952320F0CA47CE4578F78C0DAC54C9009827A8E93EBD0FA835ECD7F792AE0188AD52A35608B95325CAF34A20CBBB683A956E0FF0098AE6EF681D5CA052D1D8723BD740976A6D3BF5EF9FF003E914D3D5969D834363C0EEB72028F53FD856D749ECFAA90CCC491911100FC8F35B347A9D2B9EA755A8FE42CBB48E430079E87A1FF0063C7F6AEC7C0AF90C14D72B6ED8382315A5F687DA2BB6D8E9ECB95803738C3E403008E31D4673D22B9F4DBA5A9EEFD41E9BED27E21DBD18166CC5CBD2038CEDB6A66648E5B8F2FDEA5FC4CB2758DA75B6E36DB46B841FF00EA85009F928FFF006AF15F03D3B5DBA11416663FAF735ED57172CDE60766D1024B2AAF931D70147C87AD77EBBAB7A6B62E591BA394B1ECEA6C1BAD82623D011B5A3E4769FB91526A7D9FB688E142EC3715D495F843791B67DA7FF35D25BB6026DF8800C7D0C907B6711554495653B483BC11CE72BF28F2F4C62BE3AEA9AE598DDF038DB1ECE80CAAC30E49F38872A31BF6FE604660751F5ACB6F02DAE96D210332BB779009C4660E07EB5D5B213B0112546DDDB44471C660F499A95B4DF10121D3131D3B83FE7159975926DD1779CCE8FD96B3EED832F98B024990E7699027A0DB1C64E7AD6B75FECF22B0F286901A5A460CC46D1115DED947645CE0020939279CFF00413FDF157EC1D1EE28E8178FACF59918EC2AFEB2576DD1BB0F7489D90598C0E9832080220413FAD4779B67DC444E0EEE493D0796A8AD9007591E5E3113B8F7FAE62AA93B55492774F59839995FCBD233C9AF1C614E8F25B2ED3AF915A4C9E3F483FAFEB565D760D04600DFC492D047E823B73356DCDA2086311B0018F302BC758E07698C5437B5F0B232AA5818DC58013DB3D13E809918A2D3776813BA9820AC481D31823BF181FE4D4179195BDE4724C8C49C663D781D7FBD5EFAC2BB499F39C4F00813240E78F9D5969EDB15624CA8C0E58F0BF224C56E30756876A176F1C36D6601F303380727D147D3E752A589DE6005624107323924E4408115297DA0E4051009209CE0303C081DEA2BFAB582260AEDE30D1C2881CE411005364BE05F52D1A5645DC08E23D1A0B73D0193D4F4AC7FD9410267F2C303C9FE26F507B7CFAC54EFAE56736A41189CEE3B648FCBD711F207BD47ABBA2604E49C8227CD3C740011F7A6C9595D123B1005B5898124FF000CE09C7724FD6ADBD6CAC790AC0DBD3382260753CC7CEB186AE00276EFCCFA9869C11D2189F9D2F6B602AC1DC61A78807E620623AF20D745A529772A765CFA60CDBF10428EB812D331F3220F6C545ABB01D0AC80C418925946E92240C9E39CCCD457589044858DEAC47512330D88EBF36A89EE0F7812707CB38255013F589283E5345097C4A9E08B4BA25B6E5D84B053004ED652248619DD3B627F9BD2B677F6DB20CE0CC498E46E0ABDE33FD2B095D8DD249800923A1603760A839822477C7AD41A8DCA04AE2DA1339CB60274FE10727FBD77DAF86F2691B12A9BB7EE19C0538E483D7E83EA7B0A8F50BE5500ED646241E4131B403D84C6735A8D45F0BB5CB42F209060400488E87CE3EFF3A5B20EF962D18320905B29C0FE76563FE933C545A559B29BE561B7CC539900443090498EC541303E95069EDDB0A80B02499593B4890CA196791833CF5AE7F576DD519CBF036807E2001624C81124447FAFB8158F7CEE0ACCCFC3950BF0850403B8C4E3731EDD67A5748E85AE4D1D869D96D97B3BF72B2B5D2C78DD2018F98227FD22BCEBDA4B7E76FAFE8608FF003B5645ED5DDF7AD69FFE2A820A98603831F338819993DAB54D71EE43105BDE09519860BCF04992411FF29EE2BEAF4FBE3A6A32C94D33DD00C13198AAB5F824139060E7A8ADB6BFC21D6EED75DA72789C3F92256461B1E999E2B0DFC02EB83755491CF047977142DF4600409E54F5AF4C5C19AB319B57189FFC5645BD6D5CDE084AA620C348C06632703BED513D88EB9AD9785FB22D7109862763B6410AD0A2E2953D305019EA5818222A4FD9A5960C5B5AE1DEB3EC6A81AD8784FE1EBB212EEA1D591873B5D0F9A08201189107D0F135B33EC9B401118B6B99956801B77610AA71FC64D787527A3D9F7A326B3F6C5442EDC01F7F4FE9F7AE12E6F7B84BCEE63267993E95EB373D9417106F621ED5C33D15BF84C1F9861F28ABBC23D8BD3DA7170CBBAEE60CD192CCC4075301C848CE27F418D0EAF474632776C6E445EC2FB33FB3DAFDA6E0FDE3C055C82A8624F1C907FCE9DA794ACB6D04FE9CCC1E00C8FD47158FFB460B319C8920E1463327B833DB118A9900E4C11E6DD07826187D67AFA0CF15F235E73D69B9B32DF62DB9A6F20653060C89047CC03D6247D38C556DB1704C855DE657F9C4F300F4883EA6A3B036A6C624B12557038DC0E220600E076A951816DD23041107E9300F264FD62B94E2CC13DB55292304133E878389F41D3A1E2A4DFE5F34A99682324C738ED11F735876EEFEF03EF6055092310E0C89C61871F7EF56BDE2C43020AE48323030727A11991D8565C52CAC9A32C6A0A89E259B199FCDD23889FBFAD5ACB10258474513F782335877F5460237C4D131C0E6083C76204F5A94EA1DBCC8641F4E0F313D7E7521A72B099A73AA05DB05157803B807064CCC374EB8E6AD5D4316628F95D873CAA92499F98CF7E7AD5DAAD970CAA862D3B8EEF2A10001BA23065849C60CD623AAA483B4CED2D120960C0B1107000831EB5DD4AE9F7383C64789EAD9605B50D96C85EA3A12783B579CE48E94BDE20CDEEDADAC978C2851BD76C8DB8E4039ED158634EEE96942C31712A641082489EE48280CF61F3ABF5054A8B8FBF7DB05155495255195647AA921A044CE715EB4A384FCF3B14CF3AA47BCBBC10B865EC040DCDFF4965830460C4D41AAD6182C23CC08122085CED73121B76D02247C4440A8F54A52D5C60DB54867DCD0C00C319EA2017024FE73DAA97D8EC92A65942295E36986918307712075E2914B6FC8D60CFD3EB4DC054A9F787CBB49DA266382727CD24FF2F07690306EEA4EC50A9BCBC163CC9C03CF58656038956EF9AF86A6D01C1756B9B0B1396580AD007044BF23A9CE455F6F36D51C1C195798DAC208216700154F5C569CE1BB23920F170E37EC0DBC2296380A1BE122DF70BE51C83058F11581A8D75DF791F112514006099277B7659D8C607F10C56FF59A476B04A94F33B48249006E9F29FCB3B94E3B0E6AFD3151EEC9190800E277096C4E323A7189F9594E10C490A469F528D69420605DD54470A519499E079A037CA33DAB602F016C3DCDDFBB1B6181C918CF6CCC76E2B22CE9DDC79C6E2A410776E25599B223226187D41C74B9C930964F9893B5E14910E8CC33F51DC561EA294D44335D694DF04C30630C7773B9C0999801449EF1B715769ADDC0C45C03241DCB995032777206FC0E9C56E6DFBC61BBDDA866DACC241870C0B89C4ACCE09E20562EA442ED8018F9B130FBB77957EC074E0F6AC4B570F6AFA94B0E9218151E6828C7893720B7C3DCC67D7E557EA88171422061B8291B4995025A7B6E2077CD45FB5FEE5AF4A87284A89DA37108089F99007691DAB234DE26821C08849200C3C00DB801C9504F4E915C5B937EF309E4C7BF655F783B4A820900010C0A9E6241DAEA303AF5A9FDD6E2D9585371444AED6DA00923AFC4647103A8A9CDDB2D6D8E564318044962041FE41B48CFCFB629A9646616CC2F962264B0230401D39F941A394972FF001C1BB319151C2481BC4F94007385E44C8C0CE3306A967C355835B220B30826270154AC002242891C4A8A9134FF000B2B80B7B7A6FCB4330F29302632D827123BE328E9DBDDA9658BB6CB4493FBC8C02DB66679E7135B7B92B4CBD8D578A7835A817AE5B1BFC84B02432A8242B1FE2E15483D04CA91223D5F81A5C7B6C615432B01B46CDAB33047799E07997BD6EEF43DB1BA4FC61B689919F2BFF7C0F8BD2ACD43B5A45B8AA46D4018270604310304007A0CE074E34BA9D48A4A2F81662DEF0B54B6A8D0C509D808DCDEEDFCB9E71300FD24456C6EE81189495182F8811BCB4F03E09DA606713D2A21741672DF13885C1822271D86F56C19E0E78156960369921D029E2627F3024F997027EB516B493CF9E7DC6E20D378627BCF7B85B837C02257CC2760038C99C4C8FAC64682D5AB3EEC058C4240E0319224730CC3EE3A0356EAF52B01D369692088C103CA4418CA9044F68E2A97DBCA1C0DD8E5493040C80046E52A41EF23D04CD59C9BE6D79E7E0CDB321155A06D21981B7F1430DA4F94471E86718F9D476F5497199082BB7CC1B104003389388CF5FA41AC40636AF1277904CC2EC5DC3A16992418E4F4AC4D46B580DF84708C4B4AC3ED320A83C311BA40EAA7904573847DA27F13366EBF6A53254AEEC48CC4F4071D84CF1FD2AE0B2BE600138224C8604CA8EE388EF915ACB5E2A972DAB15891F10E63E219ED04FDE3A0AC8573765092BB54C3122558152018E399E3106B84A1B5FF00B22C9B010C0AA8E4E48320882089183040FA8FAD5F6542B092090488130D3804CE664CCFCF99AD5E9B57E4DCABC6481830792A393D73F2EF5AEB1E29FBB0D2B0250B4C82C38310704AE07107D31A8C67D8291BBD55C3B5B68121C363CB9955899C2902034FE6CD64431570446FC8925483B440273D441FF275FEFAE12B7110E7CB9C432CCAB98060F138923E55369AF9BC8428656520ED3C483104F4E089E0E22262B6A53495F2BF9359215D15C12ADE6669DAC414698CAE673B84CF24313D22AD360950991B94861E5F85A03182666718FF0078CB370B0170E1C001B307CC4762440627EC7B9ACBB37246E3B4B2E0C720704991991FDAA3D55B9BAF3CF28D246BB4761984B796D80C70DC80441004119247330DC55069C12436EF298104AE30783F339ACEB57B712B207D7E2324C139C6713DCD58FB89263FCFB8AE73D46DA491ADA731A7D4B15B5BC648019F8F3096CC4632C33FDA4DD77C44BAA99462C01DC0ED04E27E5DFE805477B530ADEF640705318209803E9B7766B5574BBB1403F836F13B40C93881F0CFD6BD4B4D4B2F83CEF274DA764501E4F95A3A156044024CE7E1227E46B2FC40DB21AE899912C4495533B880C608FED5CD5BBEA3DDEC550AE08018F981124447E5DC4FDEACF11D4DDB7B1F242DC9210608C1207A88AB18BDD4BBFDACD275C1D2EA42163B9B9B6783F10CE57A29C9FBD6BEDE8E2D0B125828018481B846F27F2C10180C75AC2FDA16E2976256DB646E214A2B02A54E6649553F5AC0D278D87B8DB60FBB065CC9246313F4E7AC53D9CB6B4BB648CE9AE2402576AC2E277104F9419EB38FD2AEB764212F058039C7F11E076004E7AC573D77C6BC88E09697B7CA830091F5F956778A6A0A1B2A5A05C0F2B8067851EB9CCF49ACFB29B59422CDB6BAF20508602AB0B8622006DC3009C4E498EBDAA0DAEB6C7F229F393920F0679C647FE6B105EF7214F26DC8625B1B3018C8E06D27D6AFB8970B904FEECB0561FC80998EF8F4A35292B6ECD34D9437987BB762706E0792040C152A7A2B6D9FB54FA2DA3DE2DA30CCEACC60AA804C8600F96704183067D6A0F145B646D0B25D811D82A8E36CE67BF106A2236940012402AD11E6106264749047CA8AEB0E9BF3238793667590A463C92A57992B8278EF03D44549A955BC4DC0594A81220193F167F5E3D739AE7D3422FDA86BA55D9802F9266678E924483DA2B27C4754FEEFF773B816323826005048C447F535970A749F2FCFBE47CD990DA456B4E9F9B6800869865219491F389F9E2AFD36B93DD8C794B8188041F28C08CCC938E82B5D675B3EECA090E40B841C010C5881D018E6A4D46A926676A90480010652483DC8103351C65C306EB497570F1E6458624101A4903D0F5307B9ACCD96DAEA3B442C913819051A07623A7A57136B50D76C5BF761B7130E67B1982471E5C4FCAB64D72E5D4C6E10A60822377AE7D3AFA56DC2519DDFAFD0D59BAD0BDA93B1FCA4CF5C91208F983023A1AC8BE415307070D3C906549060C62323BD7396A6D35A52C4A907189678E57EE0191CC56D2D2B1582A42088938F5115E79DC328642AFBB72431632A0A932ACB986C70D18F5C76159297F7082C769927A1CC48F4C08FB56126A7321B2C483B7910C60C1F9555B4E3A3169DB23EF2DF3CD1EA71609AF210C08662BB7641C1DD24820FE539607E62AD6BEA32CC3845824F9774A9041E93FEF566A5495037EE62A031E7339F9E2A1BB7496DAB92A3A6372FA7AD4BB6197A46D60AA04B306279248EE78C81F38F9541A6BDBED2A302836B408860479406220CC083593A6BBBA51C6D805413D73209FAD416D618B339170F0604098999E4F4CD7452C64077B8EC517FE20B4425CFE624F94E638DBCF6A87C47C2ED8362F33195B90660A657DD858E991BB3CE7E555F17D4B222B582A0CA8079CCE71D0463EF567ED0D7D3CB6BDE36CDFB376D05870037D1A266BB69EE6D6DEEEBF827C8C86D65B466F593B2086DC33B941C6D8618EB5A9D4FBDD39BB7576BDBDC00585E660B40304C9E0E7CBF5A3B428B8E369D84B16CC298E7B1E9F4ADAEB3DD82B6ECB1C10C64161D8A803FA9AB14A394BD7E848AB2CD3DD6DF106080C368E10820AB09919067399FBE3BDED3EDB9C30F8405FE3192719F20FB9AC5D2F88AAB358662ADBD977E541DC18923B7CCFAD57F66F7326D992211140014C945DCC7A9273F2AD6CDAE9F9E78C6DF823756752DB7DE8C238420A82430C60E6482047A639AC9B9AFDA921981833E68DCA231D4E49CF6AD0278BC5CBF6AE285164823931B84C807ACC0FBD656A2F07736DA06F120CFE58862318339AE35284963CC3FE8BC1B5BD783430121C66795581E66047430201AB74BAB8077302DE6303AA82067898001AE7DB7EEB481C05B88E164C37F0C1F4C08F9D4962C9F2DCB80926D991322664823819E9E94968AE5FF001F53566EBDE0BA5417F33173810392723B6409E902A67D66D850402000D20B1DDD4CC1AD2697C5C062B761502B3241064C88DC0490A474C47D2B602CDB7F3861064FCBD2B3A9A7B229BFC9536B28D7DF6175137798ACEE0C20904748C738FAD43AF3FBBF76EDB49006E1F1024F18E40E2AB4AE90CCD239376CD278889BD6D829455B9057900AFC223A06E6B26F6AAE7BCDF6F2837294C4B3B474F9CE7D294AF55DC536B845AF7A8CEB9A75BD6D52EA945823613D63191C902B9FB1E0AD6EE10F72774AAEC246073B9BBC1E9D4D295CB47565154B87F92AC268DDDAF0B12D0C7DD86501646401D3D248FB545A8B49750A060AD6CC823E2EB33DF207D85294D3936DB6F8E088974DE12C087B8DB86CF362774E0C4F33C5677865EDE85C9300932C40F28EFF004A52B8B939C5DFC57DC3544D740660E1A40F857AF1CCFCBA561DB6C5EB85A4C31E4C2CC42FD17FAD2948AEDE9FD996CA697521DADB85D8618982364050A27D67355B1A58BA558929B76900C0200EBD7E2AAD2B739384B05441A62C8AA84A8DAA4381107ACC9E074AAE91CDDFDE80096389C0453832471306A94ADB8AD8E5DFFEB2A566C7C3D46D640AB0A47904F9470493D781F3ACF5BCBB3DDC7981968C4741F3EF54A571D58E2FE26CD56AFC4ADDBB772F5D404A5CF2C8F3748DA7F5346F122AA2EC165EA464026327D294ADFB28EC8B7DDD7D08D5BA20BBA802EA95040B9CB663991B4FD7F5ADC69B5A0AAC11F092BDF1DE94ACEB69AAB25905CDCBE75962018E87711904556D7C036925987D41FEE3D294AE50578355DCAEB0BDD00295170419207C3D45606BB5FC069572480C04F6311D694AE9A4B7C9266663C335DBDEE23C10260888189DDE87350694A871745C70000005C77320F5EFE954A57671DB27B7E466CC8D56B16E7BDB2609319E4C7506307A541FB545B6448236ED04EE209C82A08C8E64014A56F628CB1EA5BA765359E1B62ED91EECA8B9037BE7712BCA91D7BC54FA7BE8F6950205D8EAEA4F0E2011BB9C1EDD294ACCE4DF2F8E0BB9AC98DE2178AB5CDCA46F9059164B089E76F231198AC9D2F8A5BB8858236EB78263CD6CC0C1F4E4556959518CB4F73ED5F646BB262DB2DFB69749CD9680D1CCFC50A724038359B7EC00BFBB2E08965800C3F538F894CE41A52B9EA4BD94AA3D8259A307C42FA6A22E0B7B18AED0D6C42EEF503A123F5F5A85F5F752159943409852031EAD8FF3154A5767EF6A38CBE669AC1FFFD9','hex')::bytea,6000);
            RETURN NEXT is(imgContent.image_is_valid, true, 'Test image should be valid');
            RETURN NEXT is(imgContent.is_transformed, true, 'Test image should be transformed');
            RETURN NEXT is(imgContent.image_size_original > imgContent.image_size_bytes, true, 'Test image original size should be greater than the optimized size');
            RETURN NEXT is(imgContent.image_size_bytes < 6000, true, 'Test image optimized size should be less than the optimize size');
            RETURN NEXT is(imgContent.image_format, 'JPEG', 'Test image optimized format should be JPEG format');
        END;
        $unitTestFn$;    END;
    $$ LANGUAGE PLPGSQL;

    CREATE OR REPLACE PROCEDURE ${fn.destroyIdempotent(state).qName}() AS $$
    BEGIN
        DROP FUNCTION IF EXISTS ${fn.unitTest(state).qName}();
        DROP FUNCTION IF EXISTS image_format_size(bytea);
        DROP TYPE IF EXISTS image_format_size_type;
    END;
    $$ LANGUAGE PLPGSQL;
`;
}
